name: Push CI Check

on:
  push:
    branches: [ main, master, develop, v* ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'

jobs:
  push-ci-check:
    name: Pushæ£€æµ‹å’Œæ„å»º
    runs-on: xiaobiao-ubuntu

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–æœ€è¿‘2ä¸ªcommitç”¨äºæ¯”è¾ƒ

      - name: è·å–æ¨é€ä¿¡æ¯
        run: |
          echo "=================== æ¨é€ä¿¡æ¯ ==================="
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤SHA: ${{ github.sha }}"
          echo "æäº¤è€…: ${{ github.event.head_commit.author.name }}"
          echo "æäº¤æ¶ˆæ¯: ${{ github.event.head_commit.message }}"
          echo "æ¨é€æ—¶é—´: ${{ github.event.head_commit.timestamp }}"
          echo "=============================================="

      - name: æ£€æŸ¥å˜æ›´æ–‡ä»¶
        run: |
          echo "=================== æ–‡ä»¶å˜æ›´æ£€æŸ¥ ==================="
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            echo "å˜æ›´çš„æ–‡ä»¶:"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }}
            echo ""
            echo "è¯¦ç»†å˜æ›´ç»Ÿè®¡:"
            git diff --stat ${{ github.event.before }} ${{ github.sha }}
          else
            echo "é¦–æ¬¡æ¨é€ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶"
            ls -la
          fi
          echo "=================================================="

      - name: æ£€æŸ¥main.cæ–‡ä»¶
        run: |
          echo "=================== main.c æ–‡ä»¶æ£€æŸ¥ ==================="
          if [ -f "main.c" ]; then
            echo "âœ… main.c æ–‡ä»¶å­˜åœ¨"
            echo "æ–‡ä»¶ä¿¡æ¯:"
            ls -la main.c
            echo ""
            echo "æ–‡ä»¶ç±»å‹:"
            file main.c
          else
            echo "âŒ main.c æ–‡ä»¶ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•æ‰€æœ‰.cæ–‡ä»¶:"
            find . -name "*.c" -type f
            exit 1
          fi
          echo "=================================================="

      - name: æ‰“å°main.cæ–‡ä»¶å†…å®¹
        run: |
          echo "=================== main.c æ–‡ä»¶å†…å®¹ ==================="
          echo "æ–‡ä»¶è·¯å¾„: $(pwd)/main.c"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < main.c) å­—èŠ‚"
          echo "ä»£ç è¡Œæ•°: $(wc -l < main.c) è¡Œ"
          echo ""
          echo "--- æ–‡ä»¶å†…å®¹å¼€å§‹ ---"
          cat -n main.c  # -nå‚æ•°æ˜¾ç¤ºè¡Œå·
          echo "--- æ–‡ä»¶å†…å®¹ç»“æŸ ---"
          echo "=================================================="

      - name: ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "=================== ä»£ç è´¨é‡æ£€æŸ¥ ==================="

          # æ£€æŸ¥æ˜¯å¦æœ‰mainå‡½æ•°
          if grep -q "int main" main.c; then
            echo "âœ… æ‰¾åˆ°mainå‡½æ•°"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°mainå‡½æ•°"
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰includeè¯­å¥
          if grep -q "#include" main.c; then
            echo "âœ… æ‰¾åˆ°includeè¯­å¥:"
            grep "#include" main.c
          else
            echo "âš ï¸ æœªæ‰¾åˆ°includeè¯­å¥"
          fi

          # æ£€æŸ¥æ‹¬å·åŒ¹é…
          open_braces=$(grep -o "{" main.c | wc -l)
          close_braces=$(grep -o "}" main.c | wc -l)
          if [ $open_braces -eq $close_braces ]; then
            echo "âœ… æ‹¬å·åŒ¹é…æ­£ç¡® (${open_braces}ä¸ª)"
          else
            echo "âŒ æ‹¬å·ä¸åŒ¹é…: å¼€æ‹¬å·${open_braces}ä¸ª, é—­æ‹¬å·${close_braces}ä¸ª"
          fi

          # æ£€æŸ¥åˆ†å·
          semicolons=$(grep -o ";" main.c | wc -l)
          echo "ğŸ“Š åˆ†å·æ•°é‡: ${semicolons}ä¸ª"

          echo "=================================================="

      - name: ç¼–è¯‘æ£€æŸ¥
        run: |
          echo "=================== ç¼–è¯‘æ£€æŸ¥ ==================="

          # æ£€æŸ¥æ˜¯å¦æœ‰Makefile
          if [ -f "Makefile" ]; then
            echo "æ‰¾åˆ°Makefileï¼Œä½¿ç”¨makeç¼–è¯‘..."
            make clean || true
            if make; then
              echo "âœ… makeç¼–è¯‘æˆåŠŸ"
            else
              echo "âŒ makeç¼–è¯‘å¤±è´¥"
              exit 1
            fi
          else
            echo "ä½¿ç”¨gccç¼–è¯‘..."
            if gcc -Wall -Wextra -o main main.c; then
              echo "âœ… gccç¼–è¯‘æˆåŠŸ"
              echo "å¯æ‰§è¡Œæ–‡ä»¶ä¿¡æ¯:"
              ls -la main
              echo "æ–‡ä»¶ç±»å‹:"
              file main
            else
              echo "âŒ gccç¼–è¯‘å¤±è´¥"
              exit 1
            fi
          fi

          echo "=================================================="

      - name: è¿è¡Œç¨‹åºæµ‹è¯•
        run: |
          echo "=================== ç¨‹åºè¿è¡Œæµ‹è¯• ==================="

          if [ -f "main" ]; then
            echo "å°è¯•è¿è¡Œç¼–è¯‘åçš„ç¨‹åº..."
            timeout 10s ./main || {
              exit_code=$?
              if [ $exit_code -eq 124 ]; then
                echo "âš ï¸ ç¨‹åºè¿è¡Œè¶…æ—¶ï¼ˆ10ç§’ï¼‰"
              else
                echo "ç¨‹åºé€€å‡ºç : $exit_code"
              fi
            }
          else
            echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          fi

          echo "=================================================="

      - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          echo "=================== æ„å»ºæŠ¥å‘Š ==================="
          echo "ğŸ” æ¨é€æ£€æµ‹å®Œæˆ"
          echo "ğŸ“ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ’¾ æäº¤: ${{ github.sha }}"
          echo "ğŸ“ main.c æ–‡ä»¶å·²æ£€æŸ¥å¹¶æ‰“å°"
          echo "ğŸ”¨ ç¼–è¯‘æ£€æŸ¥é€šè¿‡"
          echo "âœ… æ‰€æœ‰æ£€æŸ¥å®Œæˆ"
          echo "=============================================="

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          echo "æ¸…ç†ç¼–è¯‘äº§ç”Ÿçš„æ–‡ä»¶..."
          rm -f main *.o *.out a.out
          echo "æ¸…ç†å®Œæˆ"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼‰
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.sha }}
          path: |
            *.log
            main.c
          retention-days: 7
