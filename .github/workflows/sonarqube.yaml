name: "SonarQube Cloud Analysis"

on:
  push:
    branches: [ main, master, develop, v* ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'
  pull_request:
    branches: [ main, master, develop, v* ]
    types: [opened, synchronize, reopened]

jobs:
  sonarqube-analysis:
    name: SonarQubeä»£ç è´¨é‡åˆ†æ
    runs-on: xiaobiao-ubuntu

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´Gitå†å²ï¼ŒSonarQubeéœ€è¦

      - name: è®¾ç½®æ„å»ºç¯å¢ƒ
        run: |
          echo "å‡†å¤‡æ„å»ºç¯å¢ƒ..."
          # ç¡®ä¿gccå¯ç”¨
          gcc --version || (echo "å®‰è£…gcc..." && sudo apt-get update && sudo apt-get install -y gcc)

          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt-get update
          sudo apt-get install -y build-essential curl unzip

      - name: ä¸‹è½½SonarQube Build Wrapper
        run: |
          echo "ä¸‹è½½SonarQube Build Wrapper..."
          curl -sSLo build-wrapper-linux-x86.zip https://sonarcloud.io/static/cpp/build-wrapper-linux-x86.zip
          unzip -o build-wrapper-linux-x86.zip
          echo "âœ… Build Wrapperä¸‹è½½å®Œæˆ"

      - name: ä½¿ç”¨Build Wrapperç¼–è¯‘é¡¹ç›®
        run: |
          echo "ä½¿ç”¨Build Wrapperç¼–è¯‘Cè¯­è¨€é¡¹ç›®..."
          # æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘æ–‡ä»¶
          rm -f main *.o *.out

          # ä½¿ç”¨build-wrapperåŒ…è£…ç¼–è¯‘è¿‡ç¨‹
          ./build-wrapper-linux-x86/build-wrapper-linux-x86-64 --out-dir bw-output gcc -Wall -Wextra -g -o main main.c
          echo "âœ… ç¼–è¯‘å®Œæˆï¼Œç¼–è¯‘æ•°æ®åº“å·²ç”Ÿæˆ"

      - name: è¿è¡ŒSonarQubeåˆ†æ
        uses: SonarSource/sonarqube-scan-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.cfamily.compile-commands=bw-output/compile_commands.json

      - name: ç­‰å¾…SonarQubeè´¨é‡é—¨æ£€æŸ¥
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: ç”Ÿæˆåˆ†ææŠ¥å‘Š
        if: always()
        run: |
          echo "=================== SonarQubeåˆ†ææŠ¥å‘Š ==================="
          echo "ğŸ” ä»£ç è´¨é‡åˆ†æå®Œæˆ"
          echo "ğŸ“Š è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹SonarQube Cloudä»ªè¡¨æ¿"
          echo "ğŸ”— è®¿é—®åœ°å€: https://sonarcloud.io"
          echo "ğŸ“ é¡¹ç›®Key: gitflow"

          # æ˜¾ç¤ºåˆ†æç»“æœæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f ".scannerwork/report-task.txt" ]; then
            echo ""
            echo "ğŸ“„ åˆ†æä»»åŠ¡è¯¦æƒ…:"
            cat .scannerwork/report-task.txt
            echo ""

            # æå–é¡¹ç›®URL
            if grep -q "dashboardUrl" .scannerwork/report-task.txt; then
              dashboard_url=$(grep "dashboardUrl" .scannerwork/report-task.txt | cut -d'=' -f2-)
              echo "ğŸ“Š é¡¹ç›®ä»ªè¡¨æ¿: $dashboard_url"
            fi
          fi
          echo "=================================================="

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          rm -f main *.o *.out
          rm -rf build-wrapper-linux-x86 build-wrapper-linux-x86.zip bw-output
          echo "âœ… æ¸…ç†å®Œæˆ"